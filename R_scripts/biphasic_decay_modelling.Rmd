---
title: ''
output: html_document
---

```{r, include=FALSE}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE, threads_per_chain = 1)
library(ggplot2)
library(here)
library(dplyr)
library(readxl)
library(reshape2)
library(lubridate)
library(stringr)
library(tidyr)
library(pbmcapply)
library(ggh4x)
library(bayestestR)
library(matrixStats)
library(rstantools)
library(ggpubr)
library(purrr)
library(xtable)
library(patchwork)
library(bridgesampling)
```


Import all relevant data.
```{r, warning=FALSE}
source(here("R_scripts/functions.R"))

IgG_data <- read_excel(here("data/CP_AdjMFI_IgG_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(SampleID, "[^-]+$"), IgClass = "IgG")
IgM_data <- read_excel(here("data/CP_AdjMFI_IgM_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(SampleID, "[^-]+$"), IgClass = "IgM")
IgA_data <- read_excel(here("data/CP_AdjMFI_IgA_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(SampleID, "[^-]+$"), IgClass = "IgA")
dimeric_IgA_data <- read_excel(here("data/CP_AdjMFI_dimericIgA_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(`Sample ID`, "[^-]+$"), IgClass = "dIgA")
colnames(dimeric_IgA_data)[1] <- "SampleID"

sample_dates <- read.csv(here("data/blood_collection_dates.csv"))
sample_dates <- mutate_at(sample_dates, vars(3:9), list(ymd)) %>% filter(!if_all(c(3:9), is.na))
clinical_data <- read.csv(here("data/clinical_OCT2023.csv"))

sample_dates_coded <- sample_dates %>% mutate(Event.Name = recode(Event.Name, "Baseline Visit (A)" = "A",
                                           "6 Week Visit (B)" = "B",
                                           "24 Week Visit (E)" = "E",
                                           "2 Weeks Post Dose 1" = "V1",
                                           "2 Weeks Post Dose 2" = "V2",
                                           "3 Months Post Vaccine" = "V3",
                                           "2 Weeks Post Dose 3 (Bstr 1)" = "B1",
                                           "3 Months Post Dose 3 (Bstr 1)" = "B2",
                                           "6 Months Post Dose 3 (Bstr 1)" = "B3",
                                           "9 Months Post Dose 3 (Bstr 1)" = "B4",
                                           "12 Months Post Dose 3 (Bstr 1)" = "B5",
                                           "6 Months Post Vaccine" = "V4",
                                           "9 Month Visit (F)" = "F",
                                           "9 Months Post Vaccine" = "V5",
                                           "12 Months Post Vaccine" = "V6",
                                           "2-4 Weeks Post-infection (R1)" = "R1",
                                           "3 Months Post-infection (R2)" = "R2",
                                           "6 Months Post-infection (R3)" = "R3",
                                           "12 Month Visit (G)" = "G",
                                           "18 Week Visit (D)" = "D",
                                           "RBB1 2-4 Weeks Post Dose 4" = "RBB1",
                                           "RBB2 3 Month Post Dose 4" = "RBB2",
                                           "9 Months Post-infection (R4)" = "R4",
                                           "RBB3 6 Month Post Dose 4" = "RBB3",
                                           "12 Months Post-infection (R5)" = "R5",
                                           "2-4 Weeks Post-infection (RR1)" = "RR1",
                                           "3 Months Post-infection (RR2)" = "RR2",
                                           "15 Month Visit (H)" = "H",
                                           "18 Month Visit (I)" = "I",
                                           "12 Week Visit (C)" = "C",
                                           "21 Month Visit (J)" = "J",
                                           "24 Month Visit (K)" = "K",
                                           "6 Months Post-infection (RR3)" = "RR3",
                                           "9 Months Post-infection (RR4)" = "RR4")) %>%
  mutate(Sample_ID = paste(Record.ID, Event.Name, sep = "-"))

all_data <- full_join(rbind(IgG_data, IgM_data, IgA_data, dimeric_IgA_data), sample_dates_coded, by = join_by(SampleID == Sample_ID))
all_data <- all_data %>% group_by(Record.ID) %>% mutate(days = as.numeric(Date.of.blood.sample.collection - min(Date.of.blood.sample.collection, na.rm = T)), Record.ID = str_extract(SampleID, "([^.]+)(?=-)"))
```


Filter data and remove individuals with less than two data points, any vaccination before enrollment, or no baseline sample.
```{r}
all_data <- all_data %>%
  group_by(Record.ID) %>%
  filter(sum(!is.na(Spike)) > 1, n_distinct(Event.Name) > 1) %>% arrange(Record.ID, IgClass, days) %>% filter(!is.na(Event.Name)) %>% ungroup()

all_data <- all_data %>% filter(!Record.ID %in% c("LVCC-0094", "LVCC-0095", "LVCC-0169", "LVCC-0113", "LVCC-0120", "LVCC-0178", "LVCC-0144", "LVCC-0165", "LVCC-0150"))

vaccine_info <- clinical_data %>% select(Record.ID, Which.vaccine...Baseline.Visit..A.., Dose.3.vaccine.brand....Baseline.Visit..A.., Dose.4.vaccine.brand....Baseline.Visit..A.., Dose.5.vaccine.brand....Baseline.Visit..A.., Gender.at.birth..Baseline.Visit..A.., Age..Baseline.Visit..A..)
vaccine_info <- vaccine_info[vaccine_info$Record.ID %in% unique(all_data$Record.ID), ]
all_data <- all_data %>% left_join(vaccine_info, by = "Record.ID")
```


Separate individuals according to "naive" and "recovered" status.
```{r}
covid_naive <- all_data %>% filter(Record.ID %in% clinical_data$Record.ID[clinical_data$Please.indicate.appropriate.classification.based.on.answers....Baseline.Visit..A.. == "Non-COVID-19 healthy participant"]) %>% mutate(type = "naive")
remove_ids <- covid_naive %>% group_by(Record.ID) %>% filter(all(is.na(Dose.1)) && !any(Event.Name == "Reinfection")) %>% ungroup()
covid_naive <- covid_naive %>% filter(!Record.ID %in% unique(remove_ids$Record.ID))

covid_recovered <- all_data %>% filter(Record.ID %in% clinical_data$Record.ID[clinical_data$Please.indicate.appropriate.classification.based.on.answers....Baseline.Visit..A.. == "COVID-19 recovered participant"]) %>% mutate(type = "recovered")

naive_ids <- unique(covid_naive$Record.ID)
recovered_ids <- unique(covid_recovered$Record.ID)
```


Further separate according to which vaccine they received for their primary two doses.
```{r}
covid_naive_vaccines <- group_split(covid_naive %>% group_by(Which.vaccine...Baseline.Visit..A..))
covid_recovered_vaccines <- group_split(covid_recovered %>% group_by(Which.vaccine...Baseline.Visit..A..))
```


Run stan models for each comparison group.
```{r}
control_params <- list(adapt_delta = 0.999, max_treedepth = 12)

naive_mRNA <- rbind(covid_naive_vaccines[[2]], covid_naive_vaccines[[4]])
recovered_mRNA <- covid_recovered_vaccines[[4]]
recovered_nomRNA <- rbind(covid_recovered_vaccines[[2]], covid_recovered_vaccines[[3]])
naive_nomRNA <- rbind(covid_naive_vaccines[[1]], covid_naive_vaccines[[3]])

rec_threshold <- rbind(recovered_mRNA, recovered_nomRNA) %>% 
                 filter(IgClass %in% c("IgG", NA)) %>% 
                 filter(Event.Name %in% c("R1", "R2", "RR1", "RR2")) %>%
                 summarise(threshold = mean(NP)) %>%
                 pull(threshold)

naive_threshold <- rbind(naive_mRNA, naive_nomRNA) %>% 
                   filter(IgClass %in% c("IgG", NA)) %>% 
                   filter(Event.Name %in% c("R1", "R2", "RR1", "RR2")) %>%
                   summarise(threshold = mean(NP)) %>%
                   pull(threshold)

comparison_groups <- c("naive_mRNA", "recovered_mRNA", "recovered_nomRNA", "naive_nomRNA", "covid_recovered")
antigens <- c("Spike", "RBD")

for (group in comparison_groups) {
  for (protein in antigens) {
    inf_results <- pbmclapply(unique(get(group)$Record.ID), prep_stan_data_bp_model, get(group), protein, "IgG", mc.cores = detectCores()/2)
    
    if (group == "covid_recovered") {
      prior_inf_data <- unlist(lapply(inf_results, `[[`, 7))
      prior_inf_t <- unlist(lapply(inf_results[which(prior_inf_data > 1)], `[[`, 8))
      prior_inf_y <- unlist(lapply(inf_results[which(prior_inf_data > 1)], `[[`, 9))
      prior_inf_size <- unlist(lapply(inf_results[which(prior_inf_data > 1)], `[[`, 10))
      
      stan_data <- list(Ny = length(prior_inf_y),
                  Nt = length(prior_inf_t),
                  K = length(prior_inf_size),
                  y = prior_inf_y,
                  time = prior_inf_t,
                  size_bt = rep(1, length(prior_inf_size)),
                  size_y = prior_inf_size,
                  size_T = prior_inf_size,
                  taus = rep(0, length(prior_inf_size)),
                  A_0 = 1,
                  yrep_times = seq(0, max(prior_inf_t)+50, by=10),
                  Nyt = length(seq(0, max(prior_inf_t)+50, by=10)),
                  ids = unlist(lapply(inf_results[which(prior_inf_data > 1)], `[[`, 1)))
      
      stan_fit <- stan(file = here("stan_scripts/COVID_biphasic_model_no_multi.stan"), data = stan_data, iter =  20000, warmup = 5000, chains = 4, control = control_params)
      
    } else {
      size_data <- unlist(lapply(inf_results, `[[`, 6))
      size_tau <- unlist(lapply(inf_results, `[[`, 5))
      no_reinf_y <- unlist(lapply(inf_results[which(size_data > 1 & size_tau > 1)], `[[`, 2))
      no_reinf_t <- unlist(lapply(inf_results[which(size_data > 1 & size_tau > 1)], `[[`, 3))
      no_reinf_tau <- unlist(lapply(inf_results[which(size_data > 1 & size_tau > 1)], `[[`, 4))
      size_no_reinf_data <- unlist(lapply(inf_results[which(size_data > 1 & size_tau > 1)], `[[`, 6))
      size_new_tau <- unlist(lapply(inf_results[which(size_data > 1 & size_tau > 1)], `[[`, 5))

      
      stan_data <- list(Ny = length(no_reinf_y),
                  Nt = length(no_reinf_t),
                  K = length(size_no_reinf_data),
                  J = length(no_reinf_tau),
                  y = no_reinf_y,
                  time = no_reinf_t,
                  size_bt = size_new_tau,
                  size_y = size_no_reinf_data,
                  size_T = size_no_reinf_data,
                  taus = no_reinf_tau,
                  A_0 = 1,
                  size_multi = size_new_tau-1,
                  yrep_times = seq(0, max(no_reinf_t)+50, by=10),
                  Nyt = length(seq(0, max(no_reinf_t)+50, by=10)),
                  ids = unlist(lapply(inf_results[which(size_data > 1 & size_tau > 1)], `[[`, 1)))
      
      stan_fit <- stan(file = here("stan_scripts/COVID_biphasic_model.stan"), data = stan_data, iter =  20000, warmup = 5000, chains = 4, control = control_params)
    }
    assign(paste0("IgG_", protein, "_", group), stan_fit)
    save(list=paste0("IgG_", protein, "_", group), file = here(paste0("results/model_fits/IgG_", protein, "_", group, ".Rdata")))
    assign(paste0("IgG_", protein, "_", group, "_data"), stan_data)
    save(list=paste0("IgG_", protein, "_", group, "_data"), file = here(paste0("results/model_fits/IgG_", protein, "_", group, "_data.Rdata")))
  }
}

```

Check model diagnostics.
```{r}
traceplot(stan_fit, pars = c("beta_mu", "rho_mu", "da_mu", "dl_mu", "ds_mu", "multiplier_mu", "rate"))
traceplot(stan_fit, pars = c("beta_sd","rho_sd", "da_sd", "dl_sd", "ds_sd", "multi_sd", "rate"))

mcmc_pairs(stan_fit, pars = c("beta_mu", "rho_mu", "da_mu", "dl_mu", "ds_mu", "multiplier_mu", "rate"), diag_fun = "dens", off_diag_fun = "hex")
mcmc_pairs(stan_fit, pars = c("beta_sd","rho_sd", "da_sd", "dl_sd", "ds_sd", "multi_sd", "rate"), diag_fun = "dens", off_diag_fun = "hex")
```


# Results

Calculate the significance of demographic data across key comparison groups.
```{r}
demos <- rbind(covid_naive %>% 
               filter(Record.ID %in% IgG_Spike_naive_mRNA_data$ids) %>% 
               distinct(Record.ID, Age..Baseline.Visit..A.., Which.vaccine...Baseline.Visit..A.., Gender.at.birth..Baseline.Visit..A..) %>%
               mutate(group = "Naive mRNA"),
             covid_naive %>% 
               filter(Record.ID %in% IgG_Spike_naive_nomRNA_data$ids) %>% 
               distinct(Record.ID, Age..Baseline.Visit..A.., Which.vaccine...Baseline.Visit..A.., Gender.at.birth..Baseline.Visit..A..) %>%
               mutate(group = "Naive non-mRNA"),
             covid_recovered %>% 
               filter(Record.ID %in% IgG_Spike_recovered_mRNA_data$ids) %>% 
               distinct(Record.ID, Age..Baseline.Visit..A.., Which.vaccine...Baseline.Visit..A.., Gender.at.birth..Baseline.Visit..A..) %>%
               mutate(group = "Recovered mRNA"),
             covid_recovered %>% 
               filter(Record.ID %in% IgG_Spike_recovered_nomRNA_data$ids) %>% 
               distinct(Record.ID, Age..Baseline.Visit..A.., Which.vaccine...Baseline.Visit..A.., Gender.at.birth..Baseline.Visit..A..) %>%
               mutate(group = "Recovered non-mRNA"))

demos %>% group_by(group, Which.vaccine...Baseline.Visit..A..) %>% summarise(sample_size = n())
demos %>% group_by(group, Gender.at.birth..Baseline.Visit..A..) %>% summarise(sample_size = n())
demos %>% group_by(group) %>% summarise(age_median = median(Age..Baseline.Visit..A..), age_lower = min(Age..Baseline.Visit..A..), age_upper = max(Age..Baseline.Visit..A..))

anova <- aov(Age..Baseline.Visit..A.. ~ as.factor(group), data = demos)
summary(anova)
TukeyHSD(anova)
```


Calculate geometric mean of antibody levels 2-4 weeks after first vaccination (V1), second vaccination (V2), and booster (B1).
```{r}
V1_V2_ab <- rbind(naive_mRNA %>% 
  group_by(Record.ID) %>% 
  filter(IgClass %in% c("IgG", NA)) %>% 
  filter(as.Date(Date.of.blood.sample.collection) < min(as.Date(When.did.you.receive.your.diagnosis..), as.Date("2025-01-01"), na.rm = T)) %>%
  filter(!(NP > lag(NP) & (Spike > lag(Spike) & RBD > lag(RBD)) & NP >= naive_threshold)) %>%
  filter(Event.Name %in% c("V1", "V2", "B1")) %>%
  select(Spike, RBD, code) %>% 
        mutate(Cohort = "Naive", Vaccine = "mRNA"),
      naive_nomRNA %>% 
  group_by(Record.ID) %>% 
  filter(IgClass %in% c("IgG", NA) & Record.ID != "LVCC-0096") %>% 
  filter(as.Date(Date.of.blood.sample.collection) < min(as.Date(When.did.you.receive.your.diagnosis..), as.Date("2025-01-01"), na.rm = T)) %>%
  filter(!(NP > lag(NP) & (Spike > lag(Spike) & RBD > lag(RBD)) & NP >= naive_threshold)) %>%
  filter(Event.Name %in% c("V1", "V2", "B1")) %>%
  select(Spike, RBD, code) %>% 
        mutate(Cohort = "Naive", Vaccine = "non-mRNA"),
      recovered_mRNA %>% 
  group_by(Record.ID) %>% 
  filter(IgClass %in% c("IgG", NA) & Record.ID != "LVCC-0088") %>% 
  filter(as.Date(Date.of.blood.sample.collection) < nth(c(as.Date(When.did.you.receive.your.diagnosis..), as.Date("2025-01-01")), 2, na_rm = T)) %>%
  filter(!(NP > lag(NP) & (Spike > lag(Spike) & RBD > lag(RBD)) & NP >= rec_threshold)) %>%
  filter(Event.Name %in% c("V1", "V2", "B1")) %>%
  select(Spike, RBD, code) %>% 
        mutate(Cohort = "Recovered", Vaccine = "mRNA"),
      recovered_nomRNA %>% 
  group_by(Record.ID) %>% 
  filter(IgClass %in% c("IgG", NA)) %>% 
  filter(as.Date(Date.of.blood.sample.collection) < nth(c(as.Date(When.did.you.receive.your.diagnosis..), as.Date("2025-01-01")), 2, na_rm = T)) %>%
  filter(!(NP > lag(NP) & (Spike > lag(Spike) & RBD > lag(RBD)) & NP >= rec_threshold)) %>%
  filter(Event.Name %in% c("V1", "V2", "B1")) %>%
  select(Spike, RBD, code) %>% 
        mutate(Cohort = "Recovered", Vaccine = "non-mRNA"))

melted_ab_info <- V1_V2_ab %>% melt()

vacc_geom_means <- melted_ab_info %>% group_by(code, Cohort, Vaccine, variable) %>% reframe(geom_mean = exp(mean(log(value))))

ggplot() + 
  geom_violin(data = melted_ab_info, aes(x = Cohort, y = value, fill = Vaccine), alpha = 0.6) + 
  geom_point(data = vacc_geom_means, aes(x = Cohort, y = geom_mean, fill = Vaccine), position = position_dodge(width = .9), shape = 18, size = 6) + 
  geom_point(data = melted_ab_info, aes(x = Cohort, y = value, fill = Vaccine), position = position_dodge(width = .9), alpha = 0.2) +
  facet_grid(variable ~ factor(code, levels = c("V1", "V2", "B1")), labeller = as_labeller(c("B1" = "Booster vaccination", "V1" = "First vaccination", "V2" = "Second vaccination", "Spike" = "Spike", "RBD" = "RBD"))) + 
  theme_bw() +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), legend.title=element_text(size=22), plot.title = element_text(size=24), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ylab("Adjusted MFI") 

ggsave(here("results/paper_plots_revised/geom_mean_IgG.png"), width = 14, dpi = 300)
ggsave(here("results/paper_plots_revised/geom_mean_IgG.pdf"), width = 14, dpi = 300)

```


Calculate p-values for different groups.
```{r}
# Test across cohort
V1_V2_ab %>%
  group_by(code, Vaccine) %>%
  summarise(p_val = t.test(log(Spike) ~ Cohort)$p.value, .groups = "drop") %>% 
  mutate(p_val = format(p_val, scientific = TRUE)) %>%
  pivot_wider(names_from = code, values_from = p_val) %>% 
  relocate(Vaccine, V1, V2, B1)

V1_V2_ab %>%
  group_by(code, Vaccine) %>%
  summarise(p_val = t.test(log(RBD) ~ Cohort)$p.value, .groups = "drop") %>% 
  pivot_wider(names_from = code, values_from = p_val) %>% 
  relocate(Vaccine, V1, V2, B1)

# Test across vaccine type
V1_V2_ab %>%
  group_by(code, Cohort) %>%
  summarise(p_val = t.test(log(Spike) ~ Vaccine)$p.value, .groups = "drop") %>% 
  pivot_wider(names_from = code, values_from = p_val) %>% 
  relocate(Cohort, V1, V2, B1)

V1_V2_ab %>%
  group_by(code, Cohort) %>%
  summarise(p_val = t.test(log(RBD) ~ Vaccine)$p.value, .groups = "drop") %>% 
  pivot_wider(names_from = code, values_from = p_val) %>% 
  relocate(Cohort, V1, V2, B1)

# Test across vaccine schedule
V1_V2_ab %>%
  filter(code %in% c("V1", "V2")) %>%
  group_by(Vaccine, Cohort) %>%
  summarise(p_val = t.test(log(Spike) ~ code)$p.value, .groups = "drop") 

V1_V2_ab %>%
  filter(code %in% c("V2", "B1")) %>%
  group_by(Vaccine, Cohort) %>%
  summarise(p_val = t.test(log(Spike) ~ code)$p.value, .groups = "drop")

V1_V2_ab %>%
  filter(code %in% c("V1", "V2")) %>%
  group_by(Vaccine, Cohort) %>%
  summarise(p_val = t.test(log(RBD) ~ code)$p.value, .groups = "drop")

V1_V2_ab %>%
  filter(code %in% c("V2", "B1")) %>%
  group_by(Vaccine, Cohort) %>%
  summarise(p_val = t.test(log(RBD) ~ code)$p.value, .groups = "drop")
```


Extract all model results (note: these may need to be loaded back into the R environment)
```{r}
bp_naive_mRNA_spike <- rstan::extract(IgG_Spike_naive_mRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_naive_mRNA_rbd <- rstan::extract(IgG_RBD_naive_mRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_naive_nomRNA_spike <- rstan::extract(IgG_Spike_naive_nomRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_naive_nomRNA_rbd <- rstan::extract(IgG_RBD_naive_nomRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_rec_mRNA_spike <- rstan::extract(IgG_Spike_recovered_mRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_rec_mRNA_rbd <- rstan::extract(IgG_RBD_recovered_mRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_rec_nomRNA_spike <- rstan::extract(IgG_Spike_recovered_nomRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_rec_nomRNA_rbd <- rstan::extract(IgG_RBD_recovered_nomRNA) %>% purrr::list_modify("y_rep_model" = NULL)
bp_rec_none_spike <- rstan::extract(IgG_Spike_covid_recovered)[c("beta_mu", "dl_mu", "y_rep")]
bp_rec_none_rbd <- rstan::extract(IgG_RBD_covid_recovered)[c("beta_mu", "dl_mu", "y_rep")]

sp_naive_mRNA_spike <- rstan::extract(sp_IgG_Spike_naive_mRNA)
sp_naive_mRNA_rbd <- rstan::extract(sp_IgG_RBD_naive_mRNA)
sp_naive_nomRNA_spike <- rstan::extract(sp_IgG_Spike_naive_nomRNA)
sp_naive_nomRNA_rbd <- rstan::extract(sp_IgG_RBD_naive_nomRNA)
sp_rec_mRNA_spike <- rstan::extract(sp_IgG_Spike_recovered_mRNA)
sp_rec_mRNA_rbd <- rstan::extract(sp_IgG_RBD_recovered_mRNA)
sp_rec_nomRNA_spike <- rstan::extract(sp_IgG_Spike_recovered_nomRNA)
sp_rec_nomRNA_rbd <- rstan::extract(sp_IgG_RBD_recovered_nomRNA)
sp_rec_none_spike <- rstan::extract(sp_IgG_Spike_covid_recovered)
sp_rec_none_rbd <- rstan::extract(sp_IgG_RBD_covid_recovered)
```


Plot BP model posterior population-level parameter estimates for infection only.
```{r}
priors <- tibble(beta = rlnorm(length(bp_rec_none_spike$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 rho = rbeta(length(bp_rec_none_spike$rho_mu), 5, 2),
                 d_l = rlnorm(length(bp_rec_none_spike$dl_mu), lognormal_mean(400, 0.2), 0.2),
                 d_a = rlnorm(length(bp_rec_none_spike$da_mu), lognormal_mean(21, 0.1), 0.1),
                 d_s = rlnorm(length(bp_rec_none_spike$ds_mu), lognormal_mean(3.5, 0.15), 0.15))

priors_melted <- priors %>% melt() %>% mutate(antigen = "Prior")

posteriors <- rbind(tibble(beta = bp_rec_none_spike$beta_mu,
       rho = bp_rec_none_spike$rho_mu,
       d_l = bp_rec_none_spike$dl_mu,
       d_a = bp_rec_none_spike$da_mu,
       d_s = bp_rec_none_spike$ds_mu) %>% mutate(antigen = "Spike"),
      tibble(beta = bp_rec_none_rbd$beta_mu,
       rho = bp_rec_none_rbd$rho_mu,
       d_l = bp_rec_none_rbd$dl_mu,
       d_a = bp_rec_none_rbd$da_mu,
       d_s = bp_rec_none_rbd$ds_mu) %>% mutate(antigen = "RBD")) 

posteriors_melted <- posteriors %>% melt()

posteriors_melted$variable <- factor(posteriors_melted$variable, 
                        labels = c(beta = expression("Increase in antibodies \nper day post exposure ("*mu[beta]*")"),
                        rho = expression("Proportion of short-\nlived plasma cells ("*mu[rho]*")"),
                        d_l = expression("Half-life of long-\nlived plasma cells ("*mu[d[l]]*")"),
                        d_a = expression("Half-life of \nIgG antibodies ("*mu[d[a]]*")"),
                        d_s = expression("Half-life of short-\nlived plasma cells ("*mu[d[s]]*")")))

priors_melted$variable <- factor(priors_melted$variable,
                        labels = c(beta = expression("Increase in antibodies \nper day post exposure ("*mu[beta]*")"),
                        rho = expression("Proportion of short-\nlived plasma cells ("*mu[rho]*")"),
                        d_l = expression("Half-life of long-\nlived plasma cells ("*mu[d[l]]*")"),
                        d_a = expression("Half-life of \nIgG antibodies ("*mu[d[a]]*")"),
                        d_s = expression("Half-life of short-\nlived plasma cells ("*mu[d[s]]*")")))

rec_none_plot <- rbind(posteriors_melted, priors_melted)

rec_none_plot %>% 
ggplot(aes(value)) + 
  geom_density(aes(fill = antigen, alpha = antigen, size = antigen)) + scale_alpha_manual(values = c(Prior = 0, RBD = 0.4, Spike = 0.4)) + scale_size_manual(values = c(Prior = 0.8, RBD = 0.5, Spike = 0.5)) +
  facet_nested(~ variable, scales="free", independent = "all", labeller = label_parsed, ncol = 3) + 
  labs(fill = "Antigen response", alpha = "Antigen response", size = "Antigen response") + 
  theme_bw() + 
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), strip.text.x = element_text(size = 22, margin = margin(t = 20, b = 5)), legend.text=element_text(size=22), legend.title=element_text(size=22), plot.title = element_text(size=24), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  facetted_pos_scales(x = list(
                      variable == expression("Increase in antibodies \nper day post exposure ("*mu[beta]*")") ~ scale_x_continuous(limits = c(min(priors$beta, na.rm = T), max(priors$beta, na.rm = T))),
                      variable == expression("Proportion of short-\nlived plasma cells ("*mu[rho]*")") ~ scale_x_continuous(limits = c(min(priors$rho, na.rm = T), max(priors$rho, na.rm = T))),
                      variable == expression("Half-life of long-\nlived plasma cells ("*mu[d[l]]*")") ~ scale_x_continuous(limits = c(min(priors$d_l, na.rm = T), max(priors$d_l, na.rm = T))),
                      variable == expression("Half-life of \nIgG antibodies ("*mu[d[a]]*")") ~ scale_x_continuous(limits = c(min(priors$d_a, na.rm = T), max(priors$d_a, na.rm = T))),
                      variable == expression("Half-life of short-\nlived plasma cells ("*mu[d[s]]*")") ~ scale_x_continuous(limits = c(min(priors$d_s, na.rm = T), max(priors$d_s, na.rm = T)))
  )) + xlab("Parameter value") + ylab("Probability density")

ggsave(here("results/paper_plots_revised/pop_param_posterior_prior_rec_none.png"), width = 14, dpi = 300)

```



Plot BP model posterior population-level parameter estimates for vaccine recipients.
```{r}
inf_plot_data <- rbind(tibble(beta = bp_naive_mRNA_rbd$beta_mu,
       rho = bp_naive_mRNA_rbd$rho_mu,
       d_l = bp_naive_mRNA_rbd$dl_mu,
       d_a = bp_naive_mRNA_rbd$da_mu,
       d_s = bp_naive_mRNA_rbd$ds_mu,
       m = bp_naive_mRNA_rbd$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Naive", antigen = "RBD"),
      tibble(beta = bp_naive_nomRNA_rbd$beta_mu,
       rho = bp_naive_nomRNA_rbd$rho_mu,
       d_l = bp_naive_nomRNA_rbd$dl_mu,
       d_a = bp_naive_nomRNA_rbd$da_mu,
       d_s = bp_naive_nomRNA_rbd$ds_mu,
       m = bp_naive_nomRNA_rbd$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Naive", antigen = "RBD"),
      tibble(beta = bp_rec_mRNA_rbd$beta_mu,     
       rho = bp_rec_mRNA_rbd$rho_mu,
       d_l = bp_rec_mRNA_rbd$dl_mu,
       d_a = bp_rec_mRNA_rbd$da_mu,
       d_s = bp_rec_mRNA_rbd$ds_mu,
       m = bp_rec_mRNA_rbd$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Recovered", antigen = "RBD"),
      tibble(beta = bp_rec_nomRNA_rbd$beta_mu,
       rho = bp_rec_nomRNA_rbd$rho_mu,
       d_l = bp_rec_nomRNA_rbd$dl_mu,
       d_a = bp_rec_nomRNA_rbd$da_mu,
       d_s = bp_rec_nomRNA_rbd$ds_mu,
       m = bp_rec_nomRNA_rbd$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Recovered", antigen = "RBD"),
      tibble(beta = bp_naive_mRNA_spike$beta_mu,
       rho = bp_naive_mRNA_spike$rho_mu,
       d_l = bp_naive_mRNA_spike$dl_mu,
       d_a = bp_naive_mRNA_spike$da_mu,
       d_s = bp_naive_mRNA_spike$ds_mu,
       m = bp_naive_mRNA_spike$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Naive", antigen = "Spike"),
      tibble(beta = bp_naive_nomRNA_spike$beta_mu,
       rho = bp_naive_nomRNA_spike$rho_mu,
       d_l = bp_naive_nomRNA_spike$dl_mu,
       d_a = bp_naive_nomRNA_spike$da_mu,
       d_s = bp_naive_nomRNA_spike$ds_mu,
       m = bp_naive_nomRNA_spike$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Naive", antigen = "Spike"),
      tibble(beta = bp_rec_mRNA_spike$beta_mu,     
       rho = bp_rec_mRNA_spike$rho_mu,
       d_l = bp_rec_mRNA_spike$dl_mu,
       d_a = bp_rec_mRNA_spike$da_mu,
       d_s = bp_rec_mRNA_spike$ds_mu,
       m = bp_rec_mRNA_spike$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Recovered", antigen = "Spike"),
      tibble(beta = bp_rec_nomRNA_spike$beta_mu,
       rho = bp_rec_nomRNA_spike$rho_mu,
       d_l = bp_rec_nomRNA_spike$dl_mu,
       d_a = bp_rec_nomRNA_spike$da_mu,
       d_s = bp_rec_nomRNA_spike$ds_mu,
       m = bp_rec_nomRNA_spike$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Recovered", antigen = "Spike"))

melted_inf_data_plot <- melt(inf_plot_data)

priors_melted <- rbind(tibble(beta = rlnorm(length(bp_rec_mRNA_spike$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 rho = rbeta(length(bp_rec_mRNA_spike$rho_mu), 5, 2),
                 d_l = rlnorm(length(bp_rec_mRNA_spike$dl_mu), lognormal_mean(400, 0.2), 0.2),
                 d_a = rlnorm(length(bp_rec_mRNA_spike$da_mu), lognormal_mean(21, 0.1), 0.1),
                 d_s = rlnorm(length(bp_rec_mRNA_spike$ds_mu), lognormal_mean(3.5, 0.15), 0.15),
                 m = rlnorm(length(bp_rec_mRNA_spike$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "mRNA", cohort = "Recovered", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_naive_mRNA_spike$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 rho = rbeta(length(bp_naive_mRNA_spike$rho_mu), 5, 2),
                 d_l = rlnorm(length(bp_naive_mRNA_spike$dl_mu), lognormal_mean(400, 0.2), 0.2),
                 d_a = rlnorm(length(bp_naive_mRNA_spike$da_mu), lognormal_mean(21, 0.1), 0.1),
                 d_s = rlnorm(length(bp_naive_mRNA_spike$ds_mu), lognormal_mean(3.5, 0.15), 0.15),
                 m = rlnorm(length(bp_naive_mRNA_spike$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "mRNA", cohort = "Naive", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_rec_nomRNA_spike$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 rho = rbeta(length(bp_rec_nomRNA_spike$rho_mu), 5, 2),
                 d_l = rlnorm(length(bp_rec_nomRNA_spike$dl_mu), lognormal_mean(400, 0.2), 0.2),
                 d_a = rlnorm(length(bp_rec_nomRNA_spike$da_mu), lognormal_mean(21, 0.1), 0.1),
                 d_s = rlnorm(length(bp_rec_nomRNA_spike$ds_mu), lognormal_mean(3.5, 0.15), 0.15),
                 m = rlnorm(length(bp_rec_nomRNA_spike$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "non-mRNA", cohort = "Recovered", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_naive_nomRNA_spike$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 rho = rbeta(length(bp_naive_nomRNA_spike$rho_mu), 5, 2),
                 d_l = rlnorm(length(bp_naive_nomRNA_spike$dl_mu), lognormal_mean(400, 0.2), 0.2),
                 d_a = rlnorm(length(bp_naive_nomRNA_spike$da_mu), lognormal_mean(21, 0.1), 0.1),
                 d_s = rlnorm(length(bp_naive_nomRNA_spike$ds_mu), lognormal_mean(3.5, 0.15), 0.15),
                 m = rlnorm(length(bp_naive_nomRNA_spike$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "non-mRNA", cohort = "Naive", antigen = "Prior")) %>% melt()

melted_inf_data_plot$variable <- factor(melted_inf_data_plot$variable, 
                        labels = c(beta = expression("Increase in anti-\nbodies per day \npost exposure ("*mu[beta]*")"),
                        rho = expression("Proportion of \nshort-lived \nplasma cells ("*mu[rho]*")"),
                        d_l = expression("Half-life of \nlong-lived \nplasma cells ("*mu[d[l]]*")"),
                        d_a = expression("Half-life of \nIgG antibodies ("*mu[d[a]]*")"),
                        d_s = expression("Half-life of \nshort-lived \nplasma cells ("*mu[d[s]]*")"),
                        m = expression("Fold change in\nantibody increase\nacross exposures ("*mu[m]*")")))

priors_melted$variable <- factor(priors_melted$variable, 
                        labels = c(beta = expression("Increase in anti-\nbodies per day \npost exposure ("*mu[beta]*")"),
                        rho = expression("Proportion of \nshort-lived \nplasma cells ("*mu[rho]*")"),
                        d_l = expression("Half-life of \nlong-lived \nplasma cells ("*mu[d[l]]*")"),
                        d_a = expression("Half-life of \nIgG antibodies ("*mu[d[a]]*")"),
                        d_s = expression("Half-life of \nshort-lived \nplasma cells ("*mu[d[s]]*")"),
                        m = expression("Fold change in\nantibody increase\nacross exposures ("*mu[m]*")")))

melted_plot_data <- rbind(melted_inf_data_plot, priors_melted)

melted_plot_data %>% 
  ggplot(aes(value)) + 
  geom_density(aes(fill = antigen, alpha = antigen, size = antigen)) + scale_alpha_manual(values = c(Prior = 0, RBD = 0.4, Spike = 0.4)) + scale_size_manual(values = c(Prior = 0.8, RBD = 0.5, Spike = 0.5)) +
  facet_nested(vaccine + cohort ~ variable, scales="free", independent = "all", labeller = label_parsed) + theme(
    strip.text.x = element_text(size = 22, margin = margin(t = 40, b = 5))) + labs(fill = "Antigen response", alpha = "Antigen response", size = "Antigen response") + theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), legend.title=element_text(size=22), plot.title = element_text(size=24)) + 
  facetted_pos_scales(x = list(
                      variable == expression("Increase in anti-\nbodies per day \npost exposure ("*mu[beta]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$beta, na.rm = T), max(inf_plot_data$beta, na.rm = T))),
                      variable == expression("Proportion of \nshort-lived \nplasma cells ("*mu[rho]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$rho, na.rm = T), max(inf_plot_data$rho, na.rm = T))),
                      variable == expression("Half-life of \nlong-lived \nplasma cells ("*mu[d[l]]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$d_l, na.rm = T), max(inf_plot_data$d_l, na.rm = T))),
                      variable == expression("Half-life of \nIgG antibodies ("*mu[d[a]]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$d_a, na.rm = T), max(inf_plot_data$d_a, na.rm = T))),
                      variable == expression("Half-life of \nshort-lived \nplasma cells ("*mu[d[s]]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$d_s, na.rm = T), max(inf_plot_data$d_s, na.rm = T))),
                      variable == expression(m = expression("Fold change in\nantibody increase\nacross exposures ("*mu[m]*")")) ~ scale_x_continuous(limits = c(0, 3)))) + xlab("Parameter value") + ylab("Probability density")

ggsave(here("results/paper_plots_revised/pop_param_estimates_naive_and_rec_spike_rbd_prior_comparison.png"), width = 30, height = 15, dpi = 300)

```


Get median and credible intervals for posterior estimates of each model fit.
```{r}


# filtered_fit <- bp_naive_nomRNA_rbd[c("beta_mu", "rho_mu", "da_mu", "ds_mu", "dl_mu", "multiplier_mu", "rate")]
filtered_fit <- sp_naive_mRNA_spike[c("lambda_mu", "rate")]
posterior_median <- lapply(filtered_fit, median)

posterior_cis <- bayestestR::ci(as.data.frame(filtered_fit, ci = 0.95))[, 3:4]

x <- rbind(round(unlist(posterior_median), digits = 3), apply(posterior_cis, 1, function(x) paste("[", paste(round(x, digits=3), collapse = ", "), "]", sep="")))

xtable(x)


```


Plot antibody response half-life for BP and SP model.
```{r}
model_ab_response_decays <- rbind(tibble(d_l = bp_naive_mRNA_spike$dl_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Naive", Model = "Bi-phasic decay", antigen = "Spike"),
      tibble(d_l = bp_naive_nomRNA_spike$dl_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Naive", Model = "Bi-phasic decay", antigen = "Spike"),
      tibble(d_l = bp_rec_mRNA_spike$dl_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Recovered", Model = "Bi-phasic decay", antigen = "Spike"),
      tibble(d_l = bp_rec_nomRNA_spike$dl_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Recovered", Model = "Bi-phasic decay", antigen = "Spike"),
      tibble(d_l = bp_rec_none_spike$dl_mu) %>% mutate(Vaccine = "None", Cohort = "Recovered", Model = "Bi-phasic decay", antigen = "Spike"),
      tibble(d_l = sp_naive_mRNA_spike$lambda_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Naive", Model = "Mono-phasic decay", antigen = "Spike"),
      tibble(d_l = sp_naive_nomRNA_spike$lambda_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Naive", Model = "Mono-phasic decay", antigen = "Spike"),
      tibble(d_l = sp_rec_mRNA_spike$lambda_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Recovered", Model = "Mono-phasic decay", antigen = "Spike"),
      tibble(d_l = sp_rec_nomRNA_spike$lambda_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Recovered", Model = "Mono-phasic decay", antigen = "Spike"),
      tibble(d_l = sp_rec_none_spike$lambda_mu) %>% mutate(Vaccine = "None", Cohort = "Recovered", Model = "Mono-phasic decay", antigen = "Spike"),
      tibble(d_l = bp_naive_mRNA_rbd$dl_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Naive", Model = "Bi-phasic decay", antigen = "RBD"),
      tibble(d_l = bp_naive_nomRNA_rbd$dl_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Naive", Model = "Bi-phasic decay", antigen = "RBD"),
      tibble(d_l = bp_rec_mRNA_rbd$dl_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Recovered", Model = "Bi-phasic decay", antigen = "RBD"),
      tibble(d_l = bp_rec_nomRNA_rbd$dl_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Recovered", Model = "Bi-phasic decay", antigen = "RBD"),
      tibble(d_l = bp_rec_none_rbd$dl_mu) %>% mutate(Vaccine = "None", Cohort = "Recovered", Model = "Bi-phasic decay", antigen = "RBD"),
      tibble(d_l = sp_naive_mRNA_rbd$lambda_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Naive", Model = "Mono-phasic decay", antigen = "RBD"),
      tibble(d_l = sp_naive_nomRNA_rbd$lambda_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Naive", Model = "Mono-phasic decay", antigen = "RBD"),
      tibble(d_l = sp_rec_mRNA_rbd$lambda_mu) %>% mutate(Vaccine = "mRNA", Cohort = "Recovered", Model = "Mono-phasic decay", antigen = "RBD"),
      tibble(d_l = sp_rec_nomRNA_rbd$lambda_mu) %>% mutate(Vaccine = "non-mRNA", Cohort = "Recovered", Model = "Mono-phasic decay", antigen = "RBD"),
      tibble(d_l = sp_rec_none_rbd$lambda_mu) %>% mutate(Vaccine = "None", Cohort = "Recovered", Model = "Mono-phasic decay", antigen = "RBD"))


melted_ab_response_decays <- model_ab_response_decays %>% melt()

melted_ab_response_decays$variable <- factor(melted_ab_response_decays$antigen, 
                        labels = c(Spike = expression("Half-life of the IgG\nresponse to spike"),
                                   RBD = expression("Half-life of the IgG\nresponse to RBD")))

plot_decay_data <- melted_ab_response_decays %>% group_by(Vaccine, Cohort, Model, variable, antigen) %>% reframe(ci_min = unlist(ci(value, ci = 0.95))[2], ci_max = unlist(ci(value, ci = 0.95))[3], median = median(value))

ggplot(plot_decay_data) + 
  geom_errorbar(aes(y = Cohort, xmin = ci_min, xmax = ci_max, colour = Model), position = position_dodge(width = .75), width = .45, linewidth = 1) +
  geom_point(aes(y = Cohort, x = median, colour = Model), position = position_dodge(width = .75), size = 3) + 
  facet_grid(Vaccine ~ antigen, labeller = as_labeller(c("Spike" = "Half-life of the IgG\nresponse to spike protein", "RBD" = "Half-life of the IgG\nresponse to RBD protein", "non-mRNA" = "non-mRNA", "mRNA" = "mRNA", "None" = "None"))) + 
  xlab("Half-life (days)") + 
  theme_bw() +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 


ggsave(here("results/paper_plots_revised/ab_response_decay_rates.png"), width = 14, height = 7, dpi = 300)
ggsave(here("results/paper_plots_revised/ab_response_decay_rates.pdf"), width = 14, height = 7, dpi = 300)
```



Plot boosting parameters from BP model.
```{r}
inf_plot_data <- rbind(tibble(beta = bp_naive_mRNA_rbd$beta_mu,
       m = bp_naive_mRNA_rbd$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Naive", antigen = "RBD"),
      tibble(beta = bp_naive_nomRNA_rbd$beta_mu,
       m = bp_naive_nomRNA_rbd$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Naive", antigen = "RBD"),
      tibble(beta = bp_rec_mRNA_rbd$beta_mu,     
       m = bp_rec_mRNA_rbd$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Recovered", antigen = "RBD"),
      tibble(beta = bp_rec_nomRNA_rbd$beta_mu,
       m = bp_rec_nomRNA_rbd$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Recovered", antigen = "RBD"),
      tibble(beta = bp_rec_none_rbd$beta_mu,
       m = NA) %>% mutate(vaccine = "None", cohort = "Recovered", antigen = "RBD"),
      tibble(beta = bp_naive_mRNA_spike$beta_mu,
       m = bp_naive_mRNA_spike$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Naive", antigen = "Spike"),
      tibble(beta = bp_naive_nomRNA_spike$beta_mu,
       m = bp_naive_nomRNA_spike$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Naive", antigen = "Spike"),
      tibble(beta = bp_rec_mRNA_spike$beta_mu,     
       m = bp_rec_mRNA_spike$multiplier_mu) %>% mutate(vaccine = "mRNA", cohort = "Recovered", antigen = "Spike"),
      tibble(beta = bp_rec_nomRNA_spike$beta_mu,
       m = bp_rec_nomRNA_spike$multiplier_mu) %>% mutate(vaccine = "non-mRNA", cohort = "Recovered", antigen = "Spike"),
      tibble(beta = bp_rec_none_spike$beta_mu,
       m = NA) %>% mutate(vaccine = "None", cohort = "Recovered", antigen = "Spike"))

melted_inf_data_plot <- melt(inf_plot_data)

priors_melted <- rbind(tibble(beta = rlnorm(length(bp_naive_mRNA_rbd$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 m = rlnorm(length(bp_naive_mRNA_rbd$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "mRNA", cohort = "Recovered", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_naive_mRNA_rbd$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 m = rlnorm(length(bp_naive_mRNA_rbd$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "mRNA", cohort = "Naive", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_naive_mRNA_rbd$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 m = rlnorm(length(bp_naive_mRNA_rbd$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "non-mRNA", cohort = "Recovered", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_naive_mRNA_rbd$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 m = rlnorm(length(bp_naive_mRNA_rbd$multiplier_mu), lognormal_mean(5, 0.5), 0.5)) %>% mutate(vaccine = "non-mRNA", cohort = "Naive", antigen = "Prior"),
                 tibble(beta = rlnorm(length(bp_naive_mRNA_rbd$beta_mu), lognormal_mean(1500, 0.3), 0.3),
                 m = NA) %>% mutate(vaccine = "None", cohort = "Recovered", antigen = "Prior")) %>% melt()

melted_inf_data_plot$variable <- factor(melted_inf_data_plot$variable, 
                        labels = c(beta = expression("Increase in antibodies \nper day post exposure ("*mu[beta]*")"),
                        m = expression("Fold change in antibody \nincrease across exposures ("*mu[italic(m)]*")")))

priors_melted$variable <- factor(priors_melted$variable, 
                        labels = c(beta = expression("Increase in antibodies \nper day post exposure ("*mu[beta]*")"),
                        m = expression("Fold change in antibody \nincrease across exposures ("*mu[italic(m)]*")")))

melted_plot_data <- rbind(melted_inf_data_plot, priors_melted)

melted_plot_data %>% 
  ggplot(aes(value)) + 
  geom_density(aes(fill = antigen, alpha = antigen, size = antigen)) + scale_alpha_manual(values = c(Prior = 0, RBD = 0.4, Spike = 0.4)) + scale_size_manual(values = c(Prior = 0.8, RBD = 0.5, Spike = 0.5)) +
  facet_nested(cohort + vaccine ~ variable, scales="free", independent = "all", labeller = label_parsed) + 
  theme_bw() + 
  labs(fill = "Antigen\nresponse", alpha = "Antigen\nresponse", size = "Antigen\nresponse") + 
  theme(strip.text.x = element_text(size = 30, margin = margin(t = 40, b = 5)), axis.text=element_text(size=30), axis.title=element_text(size=30), strip.text = element_text(size = 30), legend.text=element_text(size=30), legend.title=element_text(size=30), plot.title = element_text(size=32), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  facetted_pos_scales(x = list(
                      variable == expression("Increase in antibodies \nper day post exposure ("*mu[beta]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$beta, na.rm = T), max(inf_plot_data$beta, na.rm = T))),
                      variable == expression("Fold change in antibody \nincrease across exposures ("*mu[italic(m)]*")") ~ scale_x_continuous(limits = c(min(inf_plot_data$m, na.rm = T), max(inf_plot_data$m, na.rm = T)))
  )) + xlab("Parameter value") + ylab("Probability density")


ggsave(here("results/paper_plots_revised/boosting_pop_param_estimates.png"), width = 27, height = 17, dpi = 300)
ggsave(here("results/paper_plots_revised/boosting_pop_param_estimates.pdf"), width = 27, height = 17, dpi = 300)


```


Plot model fits for SP and BP model side-by-side for sample individual.
```{r}
bp_sp_model_fits <- function(bp_results, bp_data, sp_results, sp_data) {
  biphasic_pis <- predictive_interval(bp_results$y_rep, prob = 0.95)
  single_pis <- predictive_interval(sp_results$y_rep, prob = 0.95)
  
  bp_yrep_pis <- cbind(biphasic_pis, medians = colMedians(bp_results$y_rep))
  sp_yrep_pis <- cbind(single_pis, medians = colMedians(sp_results$y_rep))
  
  sp_id_size <- c()
  pos <- 1
  for (i in 1:length(sp_data$no_segments)) {
    size <- 0
    for (j in 1:sp_data$no_segments[i]) {
      size <- size + sp_data$size_segments[pos]
      pos <- pos + 1
    }
    sp_id_size <- c(sp_id_size, size)
  }
  bp_ids <- rep(bp_data$ids, each=bp_data$Nyt)
  sp_ids <- rep(sp_data$ids, sp_id_size)

  biphasic_plot_data <- as.data.frame(bp_yrep_pis) %>% mutate(days = rep(bp_data$yrep_times, bp_data$K), ID = bp_ids)
  single_plot_data <- as.data.frame(sp_yrep_pis) %>% mutate(days = sp_data$og_times, ID = sp_ids)

  biphasic_plot_data <- as.data.frame(lapply(biphasic_plot_data, unlist)) %>% mutate(Model = "Bi-phasic decay model fit")
  single_plot_data <- as.data.frame(lapply(single_plot_data, unlist)) %>% mutate(Model = "Mono-phasic decay model fit") %>% group_by(ID) %>% mutate(group = cumsum(lag(medians, default = first(medians)) < medians) + 1)

  stan_input <- tibble(y = bp_data$y, time = bp_data$time, ID = rep(bp_data$ids, bp_data$size_y))
  biphasic_plot_data <- biphasic_plot_data %>% group_by(ID) %>% inner_join(stan_input %>% group_by(ID) %>% summarise(max_time = max(time)), by="ID") %>%   filter(days < max_time+10)

  random_id <- "LVCC-0087"
  # random_id <- sample(bp_data$ids, 1)

  ggplot() + 
    geom_point(data = stan_input %>% 
                 filter(ID == random_id), 
               aes(x = time, y = y, colour = "Observed data"), size = 3) +
  geom_ribbon(data = biphasic_plot_data %>% 
                filter(ID == random_id), 
              aes(x = days, ymin = X2.5., ymax = X97.5., fill = "95% posterior\npredictive interval"), alpha = 0.2) +
  geom_line(data = biphasic_plot_data %>% 
              filter(ID == random_id), 
            aes(x = days, y = medians, colour = "Posterior\npredictive median"), linetype = "dashed", size = 1) +
  geom_ribbon(data = single_plot_data %>% 
                filter(ID == random_id), 
              aes(x = days, ymin = X2.5., ymax = X97.5., group = group, fill = "95% posterior\npredictive interval"), alpha = 0.2) +
  geom_line(data = single_plot_data %>% 
              filter(ID == random_id), 
            aes(x = days, y = medians, group = group, colour = "Posterior\npredictive median"), linetype = "dashed", size = 1) +
    ylab("Adjusted MFI") + 
    xlab("Time since first exposure (days)") + 
    theme_bw() +
    theme(axis.text=element_text(size=25), axis.title=element_text(size=25), strip.text = element_text(size = 25), legend.text=element_text(size=25), plot.title = element_text(size=27), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title=element_blank()) + 
    facet_grid(ID ~ Model) + 
    scale_colour_manual(values = c("Observed data" = "black", "Posterior\npredictive median" = "black")) + scale_fill_manual(values = c("95% posterior\npredictive interval" = "blue"))
}

naive_mRNA_spike <- bp_sp_model_fits(bp_naive_mRNA_spike, IgG_Spike_naive_mRNA_data, sp_naive_mRNA_spike, sp_IgG_Spike_naive_mRNA_data)
naive_mRNA_rbd <- bp_sp_model_fits(bp_naive_mRNA_rbd, IgG_RBD_naive_mRNA_data, sp_naive_mRNA_rbd, sp_IgG_RBD_naive_mRNA_data)

rec_mRNA_spike <- bp_sp_model_fits(bp_rec_mRNA_spike, IgG_Spike_recovered_mRNA_data, sp_rec_mRNA_spike, sp_IgG_Spike_recovered_mRNA_data)
rec_mRNA_rbd <- bp_sp_model_fits(bp_rec_mRNA_rbd, IgG_RBD_recovered_mRNA_data, sp_rec_mRNA_rbd, sp_IgG_RBD_recovered_mRNA_data)

naive_nomRNA_spike <- bp_sp_model_fits(bp_naive_nomRNA_spike, IgG_Spike_naive_nomRNA_data, sp_naive_nomRNA_spike, sp_IgG_Spike_naive_nomRNA_data)
naive_nomRNA_rbd <- bp_sp_model_fits(bp_naive_nomRNA_rbd, IgG_RBD_naive_nomRNA_data, sp_naive_nomRNA_rbd, sp_IgG_RBD_naive_nomRNA_data)

rec_nomRNA_spike <- bp_sp_model_fits(bp_rec_nomRNA_spike, IgG_Spike_recovered_nomRNA_data, sp_rec_nomRNA_spike, sp_IgG_Spike_recovered_nomRNA_data)
rec_nomRNA_rbd <- bp_sp_model_fits(bp_rec_nomRNA_rbd, IgG_RBD_recovered_nomRNA_data, sp_rec_nomRNA_rbd, sp_IgG_RBD_recovered_nomRNA_data)

rec_none_spike <- bp_sp_model_fits(bp_rec_none_spike, IgG_Spike_covid_recovered_data, sp_rec_none_spike, sp_IgG_Spike_covid_recovered_data)
rec_none_rbd <- bp_sp_model_fits(bp_rec_none_rbd, IgG_RBD_covid_recovered_data, sp_rec_none_rbd, sp_IgG_RBD_covid_recovered_data)

(naive_mRNA_spike + theme(legend.position = "none") + 
    rec_mRNA_spike + theme(legend.position = "none")) / (naive_nomRNA_spike + theme(legend.position = "none") + rec_nomRNA_spike) / (rec_none_spike + theme(legend.position = "none") + plot_spacer()) + plot_annotation(tag_levels = 'A', tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 25))
ggsave(here(paste0("results/paper_plots_revised/spike_all_model_fits.png")), height = 20, width = 27, dpi = 300)
ggsave(here(paste0("results/paper_plots_revised/spike_all_model_fits.pdf")), height = 20, width = 27, dpi = 300)

(naive_mRNA_rbd + theme(legend.position = "none") + 
    rec_mRNA_rbd + theme(legend.position = "none")) / (naive_nomRNA_rbd + theme(legend.position = "none") + rec_nomRNA_rbd) / (rec_none_rbd + theme(legend.position = "none") + plot_spacer()) + plot_annotation(tag_levels = 'A', tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 25))
ggsave(here(paste0("results/paper_plots_revised/rbd_all_model_fits.png")), height = 20, width = 27, dpi = 300)
ggsave(here(paste0("results/paper_plots_revised/rbd_all_model_fits.pdf")), height = 20, width = 27, dpi = 300)
```


Plot model fits for BP model.
```{r}
bp_model_fits <- function(stan_file, stan_data) {
  stan_results <- get(stan_file)
  pis <- predictive_interval(stan_results$y_rep, prob = 0.95)
  yrep_pis <- cbind(pis, medians = colMedians(stan_results$y_rep))
  
  ids <- rep(stan_data$ids, each=stan_data$Nyt)
  plot_data <- as.data.frame(yrep_pis) %>% mutate(days = rep(stan_data$yrep_times, stan_data$K), ID = ids)
  plot_data <- as.data.frame(lapply(plot_data, unlist))
  stan_input <- tibble(y = stan_data$y, time = stan_data$time, ID = rep(stan_data$ids, stan_data$size_y))
  
  plot_data <- plot_data %>% group_by(ID) %>% inner_join(stan_input %>% group_by(ID) %>% summarise(max_time = max(time)), by="ID") %>%   filter(days < max_time+10)
  
  
  ggplot() + 
    geom_ribbon(data = plot_data, 
                aes(x = days, 
                    ymin = X2.5., 
                    ymax = X97.5., 
                    colour = "95% posterior\npredictive interval"), 
                alpha = 0.5) + 
    geom_point(data = stan_input, 
               aes(x = time, y = y, colour = "Observed data")) + 
    geom_line(data = plot_data, aes(x = days, y = medians, colour = "Posterior predictive\nmedian")) + 
  facet_wrap(ID ~ ., scales = "free_x", ncol = 4) + 
    ylab("Adjusted MFI") + 
    xlab("Time since first exposure (days)") + 
    scale_colour_manual(values = c("darkgrey", "black", "black")) + 
    theme_bw() + 
    theme(axis.text=element_text(size=25), axis.title=element_text(size=25), strip.text = element_text(size = 25), legend.text=element_text(size=25), plot.title = element_text(size=27), legend.title=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
  ggsave(here(paste0("results/paper_plots_revised/", stan_file, "_model_fits.png")), height = 30, width = 20, dpi = 300)
  ggsave(here(paste0("results/paper_plots_revised/", stan_file, "_model_fits.pdf")), height = 30, width = 20, dpi = 300)
}

bp_model_fits("bp_rec_none_spike", IgG_Spike_covid_recovered_data)

```


Plot pooled model fits.
```{r}
model_fit_data <- function(stan_file, stan_data) {
  stan_results <- get(stan_file)
  pis <- predictive_interval(stan_results$y_rep, prob = 0.95)
  yrep_pis <- cbind(pis, medians = colMedians(stan_results$y_rep))
  
  ids <- rep(stan_data$ids, each=stan_data$Nyt)
  plot_data <- as.data.frame(yrep_pis) %>% mutate(days = rep(stan_data$yrep_times, stan_data$K), ID = ids)
  plot_data <- as.data.frame(lapply(plot_data, unlist))
  stan_input <- tibble(y = stan_data$y, time = stan_data$time, ID = rep(stan_data$ids, stan_data$size_y))
  
  plot_data <- plot_data %>% group_by(ID) %>% inner_join(stan_input %>% group_by(ID) %>% summarise(max_time = max(time)), by="ID") %>%   filter(days < max_time+10)
  return(list(plot_data, stan_input))
}

naive_mRNA_spike_pd <- model_fit_data("bp_naive_mRNA_spike", IgG_Spike_naive_mRNA_data)
naive_mRNA_rbd_pd <- model_fit_data("bp_naive_mRNA_rbd", IgG_RBD_naive_mRNA_data)

naive_nomRNA_spike_pd <- model_fit_data("bp_naive_nomRNA_spike", IgG_Spike_naive_nomRNA_data)
naive_nomRNA_rbd_pd <- model_fit_data("bp_naive_nomRNA_rbd", IgG_RBD_naive_nomRNA_data)

rec_mRNA_spike_pd <- model_fit_data("bp_rec_mRNA_spike", IgG_Spike_recovered_mRNA_data)
rec_mRNA_rbd_pd <- model_fit_data("bp_rec_mRNA_rbd", IgG_RBD_recovered_mRNA_data)

rec_nomRNA_spike_pd <- model_fit_data("bp_rec_nomRNA_spike", IgG_Spike_recovered_nomRNA_data)
rec_nomRNA_rbd_pd <- model_fit_data("bp_rec_nomRNA_rbd", IgG_RBD_recovered_nomRNA_data)

rec_none_spike_pd <- model_fit_data("bp_rec_none_spike", IgG_Spike_covid_recovered_data)
rec_none_rbd_pd <- model_fit_data("bp_rec_none_rbd", IgG_RBD_covid_recovered_data)

spike_stan_output <- rbind(naive_mRNA_spike_pd[[1]] %>% mutate(Cohort = "Naive", Vaccine = "mRNA"),
                     naive_nomRNA_spike_pd[[1]] %>% mutate(Cohort = "Naive", Vaccine = "non-mRNA"),
                     rec_mRNA_spike_pd[[1]] %>% mutate(Cohort = "Recovered", Vaccine = "mRNA"),
                     rec_nomRNA_spike_pd[[1]] %>% mutate(Cohort = "Recovered", Vaccine = "non-mRNA"),
                     rec_none_spike_pd[[1]] %>% mutate(Cohort = "Recovered", Vaccine = "None"))

spike_stan_input <- rbind(naive_mRNA_spike_pd[[2]] %>% mutate(Cohort = "Naive", Vaccine = "mRNA"),
                     naive_nomRNA_spike_pd[[2]] %>% mutate(Cohort = "Naive", Vaccine = "non-mRNA"),
                     rec_mRNA_spike_pd[[2]] %>% mutate(Cohort = "Recovered", Vaccine = "mRNA"),
                     rec_nomRNA_spike_pd[[2]] %>% mutate(Cohort = "Recovered", Vaccine = "non-mRNA"),
                     rec_none_spike_pd[[2]] %>% mutate(Cohort = "Recovered", Vaccine = "None"))

rbd_stan_output <- rbind(naive_mRNA_rbd_pd[[1]] %>% mutate(Cohort = "Naive", Vaccine = "mRNA"),
                     naive_nomRNA_rbd_pd[[1]] %>% mutate(Cohort = "Naive", Vaccine = "non-mRNA"),
                     rec_mRNA_rbd_pd[[1]] %>% mutate(Cohort = "Recovered", Vaccine = "mRNA"),
                     rec_nomRNA_rbd_pd[[1]] %>% mutate(Cohort = "Recovered", Vaccine = "non-mRNA"),
                     rec_none_rbd_pd[[1]] %>% mutate(Cohort = "Recovered", Vaccine = "None"))

rbd_stan_input <- rbind(naive_mRNA_rbd_pd[[2]] %>% mutate(Cohort = "Naive", Vaccine = "mRNA"),
                     naive_nomRNA_rbd_pd[[2]] %>% mutate(Cohort = "Naive", Vaccine = "non-mRNA"),
                     rec_mRNA_rbd_pd[[2]] %>% mutate(Cohort = "Recovered", Vaccine = "mRNA"),
                     rec_nomRNA_rbd_pd[[2]] %>% mutate(Cohort = "Recovered", Vaccine = "non-mRNA"),
                     rec_none_rbd_pd[[2]] %>% mutate(Cohort = "Recovered", Vaccine = "None"))

ggplot() + 
  geom_line(data = spike_stan_output, aes(x = days, y = medians, group = ID, colour = "Posterior predictive\nmedian")) +
  geom_ribbon(data = spike_stan_output, aes(ymin = X2.5., ymax = X97.5., x = days, group = ID, fill = "95% posterior\npredictive interval"), alpha = 0.08) + 
  geom_point(data = spike_stan_input, aes(x = time, y = y, colour = "Observed data")) +
  facet_grid2(Vaccine ~ Cohort, render_empty = FALSE) +
  scale_colour_manual(values = c("black", "black")) + 
  scale_fill_manual(values = c("darkgrey")) + 
  theme_bw() +
  theme(axis.text=element_text(size=25), axis.title=element_text(size=25), strip.text = element_text(size = 25), legend.text=element_text(size=25), plot.title = element_text(size=27), legend.title=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab("Time (days)") +
  ylab("Adjusted MFI")
ggsave(here(paste0("results/paper_plots_revised/spike_pooled_model_fits.png")), height = 15, width = 20, dpi = 300)
ggsave(here(paste0("results/paper_plots_revised/spike_pooled_model_fits.pdf")), height = 15, width = 20, dpi = 300)


ggplot() + 
  geom_line(data = rbd_stan_output, aes(x = days, y = medians, group = ID, colour = "Posterior predictive\nmedian")) +
  geom_ribbon(data = rbd_stan_output, aes(ymin = X2.5., ymax = X97.5., x = days, group = ID, fill = "95% posterior\npredictive interval"), alpha = 0.08) + 
  geom_point(data = rbd_stan_input, aes(x = time, y = y, colour = "Observed data")) +
  facet_grid2(Vaccine ~ Cohort, render_empty = FALSE) +
  scale_colour_manual(values = c("black", "black")) + 
  scale_fill_manual(values = c("darkgrey")) + 
  theme_bw() +
  theme(axis.text=element_text(size=25), axis.title=element_text(size=25), strip.text = element_text(size = 25), legend.text=element_text(size=25), plot.title = element_text(size=27), legend.title=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab("Time (days)") +
  ylab("Adjusted MFI")
ggsave(here(paste0("results/paper_plots_revised/rbd_pooled_model_fits.png")), height = 15, width = 20, dpi = 300)
ggsave(here(paste0("results/paper_plots_revised/rbd_pooled_model_fits.pdf")), height = 15, width = 20, dpi = 300)
```



Correlation plots for LLPC half-life and m for exposures times and age.
```{r}
llpc_corr_plot_data <- rbind(tibble(d_l = colMedians(bp_naive_mRNA_rbd$d_l), 
                                    total_exposure = IgG_RBD_naive_mRNA_data$time[cumsum(IgG_RBD_naive_mRNA_data$size_T)], 
                                    no_exposure = IgG_RBD_naive_mRNA_data$size_bt,
                                    median_interval = tibble(exposures = IgG_RBD_naive_mRNA_data$taus, 
                                                             id = rep(IgG_RBD_naive_mRNA_data$id, times=IgG_RBD_naive_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_RBD_naive_mRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_naive %>% 
                                      filter(Record.ID %in% IgG_RBD_naive_mRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_RBD_naive_mRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
                               mutate(Vaccine = "mRNA", Cohort = "Naive", antigen = "RBD", id = IgG_RBD_naive_mRNA_data$ids),
      tibble(d_l = colMedians(bp_naive_nomRNA_rbd$d_l), 
                                    total_exposure = IgG_RBD_naive_nomRNA_data$time[cumsum(IgG_RBD_naive_nomRNA_data$size_T)], 
                                    no_exposure = IgG_RBD_naive_nomRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_RBD_naive_nomRNA_data$taus, 
                                                             id = rep(IgG_RBD_naive_nomRNA_data$id, times=IgG_RBD_naive_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_RBD_naive_nomRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_naive %>% 
                                      filter(Record.ID %in% IgG_RBD_naive_nomRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_RBD_naive_nomRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "non-mRNA", Cohort = "Naive", antigen = "RBD", id = IgG_RBD_naive_nomRNA_data$ids),
      tibble(d_l = colMedians(bp_rec_mRNA_rbd$d_l),
             total_exposure = IgG_RBD_recovered_mRNA_data$time[cumsum(IgG_RBD_recovered_mRNA_data$size_T)], 
             no_exposure = IgG_RBD_recovered_mRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_RBD_recovered_mRNA_data$taus, 
                                                             id = rep(IgG_RBD_recovered_mRNA_data$id, times=IgG_RBD_recovered_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      filter(row_number() != 1) %>%
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_RBD_recovered_mRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_recovered %>% 
                                      filter(Record.ID %in% IgG_RBD_recovered_mRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_RBD_recovered_mRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "mRNA", Cohort = "Recovered", antigen = "RBD", id = IgG_RBD_recovered_mRNA_data$ids),
      tibble(d_l = colMedians(bp_rec_nomRNA_rbd$d_l),
             total_exposure = IgG_RBD_recovered_nomRNA_data$time[cumsum(IgG_RBD_recovered_nomRNA_data$size_T)], 
             no_exposure = IgG_RBD_recovered_nomRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_RBD_recovered_nomRNA_data$taus, 
                                                             id = rep(IgG_RBD_recovered_nomRNA_data$id, times=IgG_RBD_recovered_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      filter(row_number() != 1) %>%
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_RBD_recovered_nomRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_recovered %>% 
                                      filter(Record.ID %in% IgG_RBD_recovered_nomRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_RBD_recovered_nomRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "non-mRNA", Cohort = "Recovered", antigen = "RBD", id = IgG_RBD_recovered_nomRNA_data$ids),
      tibble(d_l = colMedians(bp_naive_mRNA_spike$d_l),
             total_exposure = IgG_Spike_naive_mRNA_data$time[cumsum(IgG_Spike_naive_mRNA_data$size_T)], 
             no_exposure = IgG_Spike_naive_mRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_Spike_naive_mRNA_data$taus, 
                                                             id = rep(IgG_Spike_naive_mRNA_data$id, times=IgG_Spike_naive_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_Spike_naive_mRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_naive %>% 
                                      filter(Record.ID %in% IgG_Spike_naive_mRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_Spike_naive_mRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "mRNA", Cohort = "Naive", antigen = "Spike", id = IgG_Spike_naive_mRNA_data$ids),
      tibble(d_l = colMedians(bp_naive_nomRNA_spike$d_l),
             total_exposure = IgG_Spike_naive_nomRNA_data$time[cumsum(IgG_Spike_naive_nomRNA_data$size_T)],
             no_exposure = IgG_Spike_naive_nomRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_Spike_naive_nomRNA_data$taus, 
                                                             id = rep(IgG_Spike_naive_nomRNA_data$id, times=IgG_Spike_naive_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_Spike_naive_nomRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_naive %>% 
                                      filter(Record.ID %in% IgG_Spike_naive_nomRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_Spike_naive_nomRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "non-mRNA", Cohort = "Naive", antigen = "Spike", id = IgG_Spike_naive_nomRNA_data$ids),
      tibble(d_l = colMedians(bp_rec_mRNA_spike$d_l),
             total_exposure = IgG_Spike_recovered_mRNA_data$time[cumsum(IgG_Spike_recovered_mRNA_data$size_T)], 
             no_exposure = IgG_Spike_recovered_mRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_Spike_recovered_mRNA_data$taus, 
                                                             id = rep(IgG_Spike_recovered_mRNA_data$id, times=IgG_Spike_recovered_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      filter(row_number() != 1) %>%
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_Spike_recovered_mRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_recovered %>% 
                                      filter(Record.ID %in% IgG_Spike_recovered_mRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_Spike_recovered_mRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "mRNA", Cohort = "Recovered", antigen = "Spike", id = IgG_Spike_recovered_mRNA_data$ids),
      tibble(d_l = colMedians(bp_rec_nomRNA_spike$d_l),
             total_exposure = IgG_Spike_recovered_nomRNA_data$time[cumsum(IgG_Spike_recovered_nomRNA_data$size_T)], 
             no_exposure = IgG_Spike_recovered_nomRNA_data$size_bt,
             median_interval = tibble(exposures = IgG_Spike_recovered_nomRNA_data$taus, 
                                                             id = rep(IgG_Spike_recovered_nomRNA_data$id, times=IgG_Spike_recovered_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      filter(row_number() != 1) %>%
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      summarise(median_interval = median(time_diff)) %>% arrange(match(id, IgG_Spike_recovered_nomRNA_data$ids)) %>% 
                                      pull(median_interval),
                                    age = covid_recovered %>% 
                                      filter(Record.ID %in% IgG_Spike_recovered_nomRNA_data$ids) %>% 
                                      distinct(Record.ID, Age..Baseline.Visit..A..) %>% 
                                      arrange(match(Record.ID, IgG_Spike_recovered_nomRNA_data$ids)) %>% 
                                      pull(Age..Baseline.Visit..A..)) %>% 
        mutate(Vaccine = "non-mRNA", Cohort = "Recovered", antigen = "Spike", id = IgG_Spike_recovered_nomRNA_data$ids))

```

```{r}
m_corr_plot_data <- rbind(calculate_antibody_boosts(bp_naive_mRNA_rbd, IgG_RBD_naive_mRNA_data) %>% 
                            mutate(day = IgG_RBD_naive_mRNA_data$taus, 
                                   exposure_interval = tibble(exposures = IgG_RBD_naive_mRNA_data$taus, 
                                                             id = rep(IgG_RBD_naive_mRNA_data$id, times=IgG_RBD_naive_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      arrange(match(id, IgG_RBD_naive_mRNA_data$ids)) %>%
                                     pull(time_diff),
                                   Vaccine = "mRNA", Cohort = "Naive", antigen = "RBD"),
      calculate_antibody_boosts(bp_naive_nomRNA_rbd, IgG_RBD_naive_nomRNA_data) %>% 
        mutate(day = IgG_RBD_naive_nomRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_RBD_naive_nomRNA_data$taus, 
                                                             id = rep(IgG_RBD_naive_nomRNA_data$id, times=IgG_RBD_naive_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      arrange(match(id, IgG_RBD_naive_nomRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "non-mRNA", Cohort = "Naive", antigen = "RBD"),
      calculate_antibody_boosts(bp_rec_mRNA_rbd, IgG_RBD_recovered_mRNA_data) %>% 
        mutate(day = IgG_RBD_recovered_mRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_RBD_recovered_mRNA_data$taus, 
                                                             id = rep(IgG_RBD_recovered_mRNA_data$id, times=IgG_RBD_recovered_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - nth(exposures, 2)) %>% 
                                      arrange(match(id, IgG_RBD_recovered_mRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "mRNA", Cohort = "Recovered", antigen = "RBD"),
      calculate_antibody_boosts(bp_rec_nomRNA_rbd, IgG_RBD_recovered_nomRNA_data) %>% 
        mutate(day = IgG_RBD_recovered_nomRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_RBD_recovered_nomRNA_data$taus, 
                                                             id = rep(IgG_RBD_recovered_nomRNA_data$id, times=IgG_RBD_recovered_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - nth(exposures, 2)) %>% 
                                      arrange(match(id, IgG_RBD_recovered_nomRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "non-mRNA", Cohort = "Recovered", antigen = "RBD"),
      calculate_antibody_boosts(bp_naive_mRNA_spike, IgG_Spike_naive_mRNA_data) %>% 
        mutate(day = IgG_Spike_naive_mRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_Spike_naive_mRNA_data$taus, 
                                                             id = rep(IgG_Spike_naive_mRNA_data$id, times=IgG_Spike_naive_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      arrange(match(id, IgG_Spike_naive_mRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "mRNA", Cohort = "Naive", antigen = "Spike"),
      calculate_antibody_boosts(bp_naive_nomRNA_spike, IgG_Spike_naive_nomRNA_data) %>% 
        mutate(day = IgG_Spike_naive_nomRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_Spike_naive_nomRNA_data$taus, 
                                                             id = rep(IgG_Spike_naive_nomRNA_data$id, times=IgG_Spike_naive_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - first(exposures)) %>% 
                                      arrange(match(id, IgG_Spike_naive_nomRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "non-mRNA", Cohort = "Naive", antigen = "Spike"),
      calculate_antibody_boosts(bp_rec_mRNA_spike, IgG_Spike_recovered_mRNA_data) %>% 
        mutate(day = IgG_Spike_recovered_mRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_Spike_recovered_mRNA_data$taus, 
                                                             id = rep(IgG_Spike_recovered_mRNA_data$id, times=IgG_Spike_recovered_mRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - nth(exposures, 2)) %>% 
                                      arrange(match(id, IgG_Spike_recovered_mRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "mRNA", Cohort = "Recovered", antigen = "Spike"),
      calculate_antibody_boosts(bp_rec_nomRNA_spike, IgG_Spike_recovered_nomRNA_data) %>% 
        mutate(day = IgG_Spike_recovered_nomRNA_data$taus, 
               exposure_interval = tibble(exposures = IgG_Spike_recovered_nomRNA_data$taus, 
                                                             id = rep(IgG_Spike_recovered_nomRNA_data$id, times=IgG_Spike_recovered_nomRNA_data$size_bt)) %>% 
                                      group_by(id) %>% 
                                      mutate(time_diff = exposures - nth(exposures, 2)) %>% 
                                      arrange(match(id, IgG_Spike_recovered_nomRNA_data$ids)) %>%
                                     pull(time_diff),
               Vaccine = "non-mRNA", Cohort = "Recovered", antigen = "Spike"))

full_plot_data <- full_join(llpc_corr_plot_data, m_corr_plot_data, by=c("id", "Vaccine", "Cohort", "antigen"))
```


```{r}
llpcs_age <- ggplot() + geom_point(data = llpc_corr_plot_data, aes(x = age, y = d_l, colour = Cohort, shape = Vaccine), size = 4) +
  theme_bw() +
  ylab("Median estimate of LLPC half-life (days)") +
  xlab("Age (years)") +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position="none") + facet_wrap(antigen ~ .)

m_age <- ggplot() + geom_point(data = full_plot_data, aes(x = age, y = median_boost, colour = Cohort, shape = Vaccine), size = 4) +
  theme_bw() +
  ylab("Median estimate of antibody increase per exposure (adjusted MFI)") +
  xlab("Age (years)") +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + facet_wrap(antigen ~ .)

llpcs_age + m_age + plot_annotation(tag_levels = 'A', tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 22))

ggsave(here("results/paper_plots_revised/llpc_m_age_plots.pdf"), width = 18, height = 10, dpi = 300)
ggsave(here("results/paper_plots_revised/llpc_m_age_plots.png"), width = 18, height = 10, dpi = 300)


llpc_interval <- ggplot() + geom_point(data = llpc_corr_plot_data, aes(x = median_interval, y = d_l, colour = Cohort, shape = Vaccine), size = 4) +
  theme_bw() +
  ylab("Median estimate of LLPC half-life (days)") +
  xlab("Median time between vaccinations (days)") +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position="none") + scale_x_continuous(breaks = seq(0, 249, by = 50)) + facet_wrap(antigen ~ .)

m_interval <- ggplot() + geom_point(data = m_corr_plot_data %>% filter(exposure_interval >= 0), aes(x = exposure_interval, y = median_boost, colour = Cohort, shape = Vaccine), size = 4) +
  theme_bw() +
  ylab("Median estimate of antibody increase per exposure (adjusted MFI)") +
  xlab("Time between vaccinations (days)") +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + facet_wrap(antigen ~ .)

llpc_interval + m_interval + plot_annotation(tag_levels = 'A', tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 22))

ggsave(here("results/paper_plots_revised/llpc_m_interval_plots.pdf"), width = 18, height = 10, dpi = 300)
ggsave(here("results/paper_plots_revised/llpc_m_interval_plots.png"), width = 18, height = 10, dpi = 300)



llpcs_num_exp <- ggplot() + geom_point(data = llpc_corr_plot_data, aes(x = no_exposure, y = d_l, colour = Cohort, shape = Vaccine), size = 4) +
  theme_bw() +
  ylab("Median estimate of LLPC half-life (days)") +
  xlab("Number of exposures") +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position="none") + facet_wrap(antigen ~ .)

m_num_exp <- ggplot() + geom_point(data = m_corr_plot_data, aes(x = exposure, y = median_boost, colour = Cohort, shape = Vaccine), size = 4) +
  theme_bw() +
  ylab("Median estimate of antibody increase per exposure (adjusted MFI)") +
  xlab("Number of exposures") +
  theme(axis.text=element_text(size=22), axis.title=element_text(size=22), strip.text = element_text(size = 22), legend.text=element_text(size=22), plot.title = element_text(size=24), legend.title=element_text(size=22), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + facet_wrap(antigen ~ .)

llpcs_num_exp + m_num_exp + plot_annotation(tag_levels = 'A', tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 22))

ggsave(here("results/paper_plots_revised/llpc_m_num_exp_plots.pdf"), width = 18, height = 10, dpi = 300)
ggsave(here("results/paper_plots_revised/llpc_m_num_exp_plots.png"), width = 18, height = 10, dpi = 300)
```




Model comparison with Bayes Factor.
```{r}
loo_1 <- loo(IgG_Spike_naive_mRNA, save_psis = TRUE, moment_match = TRUE, cores = detectCores()/2)
loo_2 <- loo(two_beta_fit, save_psis = TRUE, moment_match = TRUE, cores = detectCores()/2)
# loo_1 <- loo(one_beta_fit)
# loo_2 <- loo(two_beta_fit)
loo_1 <- loo_moment_match(fit, loo(fit))

loo_compare(loo_1, loo_2)

ppc_loo_pit_overlay(stan_data$y, rstan::extract(one_beta_fit)$y_rep, loo_1$psis_object$log_weights)


which(pareto_k_values(loo_1) > 0.7)
which(pareto_k_values(loo_2) > 0.7)
all_y[which(pareto_k_values > 0.7)]


sp_stan_obj <- stan(
      file = here("stan_scripts/COVID_monophasic_model.stan"),
      data = sp_IgG_Spike_recovered_mRNA_data,
      chains = 0 # Set chains to 0 to not sample
    )

bp_stan_obj <- stan(
      file = here("stan_scripts/COVID_biphasic_model.stan"),
      data = IgG_Spike_recovered_mRNA_data,
      chains = 0 # Set chains to 0 to not sample
    )

# Calculate marginal likelihoods
bridge1 <- bridge_sampler(samples = IgG_Spike_recovered_mRNA, stanfit_model = bp_stan_obj)
bridge2 <- bridge_sampler(samples = sp_IgG_Spike_recovered_mRNA, stanfit_model = sp_stan_obj)
bayes_factor(bridge1, bridge2)

```






















