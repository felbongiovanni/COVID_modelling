---
title: ''
output: html_document
---

```{r, include=FALSE}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE, threads_per_chain = 1)
library(ggplot2)
# library(tidybayes)
# library(ggpubr)
library(here)
library(dplyr)
library(readxl)
# library(rstanarm)
library(reshape2)
library(lubridate)
library(stringr)
library(tidyr)
library(pbmcapply)
# library(tidyverse)
# library(bayesplot)
# library(BayesTools)
# library(caret)
# library(brms)
library(ggh4x)
library(bayestestR)
# library(matrixStats)
```


Import all relevant data.
```{r, warning=FALSE}
source(here("R_scripts/functions.R"))

IgG_data <- read_excel(here("data/CP_AdjMFI_IgG_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(SampleID, "[^-]+$"), IgClass = "IgG")
IgM_data <- read_excel(here("data/CP_AdjMFI_IgM_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(SampleID, "[^-]+$"), IgClass = "IgM")
IgA_data <- read_excel(here("data/CP_AdjMFI_IgA_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(SampleID, "[^-]+$"), IgClass = "IgA")
dimeric_IgA_data <- read_excel(here("data/CP_AdjMFI_dimericIgA_Dec2023_FINAL.xlsx")) %>% mutate(code = str_extract(`Sample ID`, "[^-]+$"), IgClass = "dIgA")
colnames(dimeric_IgA_data)[1] <- "SampleID"

sample_dates <- read.csv(here("data/blood_collection_dates.csv"))
sample_dates <- mutate_at(sample_dates, vars(3:9), list(ymd)) %>% filter(!if_all(c(3:9), is.na))
clinical_data <- read.csv(here("data/clinical_OCT2023.csv"))

sample_dates_coded <- sample_dates %>% mutate(Event.Name = recode(Event.Name, "Baseline Visit (A)" = "A",
                                           "6 Week Visit (B)" = "B",
                                           "24 Week Visit (E)" = "E",
                                           "2 Weeks Post Dose 1" = "V1",
                                           "2 Weeks Post Dose 2" = "V2",
                                           "3 Months Post Vaccine" = "V3",
                                           "2 Weeks Post Dose 3 (Bstr 1)" = "B1",
                                           "3 Months Post Dose 3 (Bstr 1)" = "B2",
                                           "6 Months Post Dose 3 (Bstr 1)" = "B3",
                                           "9 Months Post Dose 3 (Bstr 1)" = "B4",
                                           "12 Months Post Dose 3 (Bstr 1)" = "B5",
                                           "6 Months Post Vaccine" = "V4",
                                           "9 Month Visit (F)" = "F",
                                           "9 Months Post Vaccine" = "V5",
                                           "12 Months Post Vaccine" = "V6",
                                           "2-4 Weeks Post-infection (R1)" = "R1",
                                           "3 Months Post-infection (R2)" = "R2",
                                           "6 Months Post-infection (R3)" = "R3",
                                           "12 Month Visit (G)" = "G",
                                           "18 Week Visit (D)" = "D",
                                           "RBB1 2-4 Weeks Post Dose 4" = "RBB1",
                                           "RBB2 3 Month Post Dose 4" = "RBB2",
                                           "9 Months Post-infection (R4)" = "R4",
                                           "RBB3 6 Month Post Dose 4" = "RBB3",
                                           "12 Months Post-infection (R5)" = "R5",
                                           "2-4 Weeks Post-infection (RR1)" = "RR1",
                                           "3 Months Post-infection (RR2)" = "RR2",
                                           "15 Month Visit (H)" = "H",
                                           "18 Month Visit (I)" = "I",
                                           "12 Week Visit (C)" = "C",
                                           "21 Month Visit (J)" = "J",
                                           "24 Month Visit (K)" = "K",
                                           "6 Months Post-infection (RR3)" = "RR3",
                                           "9 Months Post-infection (RR4)" = "RR4")) %>%
  mutate(Sample_ID = paste(Record.ID, Event.Name, sep = "-"))

all_data <- full_join(rbind(IgG_data, IgM_data, IgA_data, dimeric_IgA_data), sample_dates_coded, by = join_by(SampleID == Sample_ID))
all_data <- all_data %>% group_by(Record.ID) %>% mutate(days = as.numeric(Date.of.blood.sample.collection - min(Date.of.blood.sample.collection, na.rm = T)), Record.ID = str_extract(SampleID, "([^.]+)(?=-)"))
```


Filter data and remove individuals with less than two data points, any vaccination before enrollment, or no baseline sample.
```{r}
all_data <- all_data %>%
  group_by(Record.ID) %>%
  filter(sum(!is.na(Spike)) > 1, n_distinct(Event.Name) > 1) %>% arrange(Record.ID, IgClass, days) %>% filter(!is.na(Event.Name)) %>% ungroup()

all_data <- all_data %>% filter(!Record.ID %in% c("LVCC-0094", "LVCC-0095", "LVCC-0169", "LVCC-0113", "LVCC-0120", "LVCC-0178", "LVCC-0144", "LVCC-0165", "LVCC-0150"))

vaccine_info <- clinical_data %>% select(Record.ID, Which.vaccine...Baseline.Visit..A.., Dose.3.vaccine.brand....Baseline.Visit..A.., Dose.4.vaccine.brand....Baseline.Visit..A.., Dose.5.vaccine.brand....Baseline.Visit..A.., Gender.at.birth..Baseline.Visit..A.., Age..Baseline.Visit..A..)
vaccine_info <- vaccine_info[vaccine_info$Record.ID %in% unique(all_data$Record.ID), ]
all_data <- all_data %>% left_join(vaccine_info, by = "Record.ID")
```


Separate individuals according to "naive" and "recovered" status.
```{r}
covid_naive <- all_data %>% filter(Record.ID %in% clinical_data$Record.ID[clinical_data$Please.indicate.appropriate.classification.based.on.answers....Baseline.Visit..A.. == "Non-COVID-19 healthy participant"]) %>% mutate(type = "naive")
remove_ids <- covid_naive %>% group_by(Record.ID) %>% filter(all(is.na(Dose.1)) && !any(Event.Name == "Reinfection")) %>% ungroup()
covid_naive <- covid_naive %>% filter(!Record.ID %in% unique(remove_ids$Record.ID))

covid_recovered <- all_data %>% filter(Record.ID %in% clinical_data$Record.ID[clinical_data$Please.indicate.appropriate.classification.based.on.answers....Baseline.Visit..A.. == "COVID-19 recovered participant"]) %>% mutate(type = "recovered")

naive_ids <- unique(covid_naive$Record.ID)
recovered_ids <- unique(covid_recovered$Record.ID)
```


Further separate according to which vaccine they received for their primary two doses.
```{r}
covid_naive_vaccines <- group_split(covid_naive %>% group_by(Which.vaccine...Baseline.Visit..A..))
covid_recovered_vaccines <- group_split(covid_recovered %>% group_by(Which.vaccine...Baseline.Visit..A..))
```


Run stan models for each comparison group.
```{r}
control_params <- list(adapt_delta = 0.8, max_treedepth = 10)

naive_mRNA <- rbind(covid_naive_vaccines[[2]], covid_naive_vaccines[[4]])
recovered_mRNA <- covid_recovered_vaccines[[4]]
recovered_nomRNA <- rbind(covid_recovered_vaccines[[2]], covid_recovered_vaccines[[3]])
naive_nomRNA <- rbind(covid_naive_vaccines[[1]], covid_naive_vaccines[[3]])

rec_threshold <- rbind(recovered_mRNA, recovered_nomRNA) %>% 
                 filter(IgClass %in% c("IgG", NA)) %>% 
                 filter(Event.Name %in% c("R1", "R2", "RR1", "RR2")) %>%
                 summarise(threshold = mean(NP)) %>%
                 pull(threshold)

naive_threshold <- rbind(naive_mRNA, naive_nomRNA) %>% 
                   filter(IgClass %in% c("IgG", NA)) %>% 
                   filter(Event.Name %in% c("R1", "R2", "RR1", "RR2")) %>%
                   summarise(threshold = mean(NP)) %>%
                   pull(threshold)

comparison_groups <- c("naive_mRNA", "recovered_mRNA", "recovered_nomRNA", "naive_nomRNA", "covid_recovered")
antigens <- c("Spike", "RBD")

for (group in comparison_groups) {
  for (protein in antigens) {
    inf_results <- pbmclapply(unique(get(group)$Record.ID), prep_stan_data_sp_model, get(group), protein, "IgG", mc.cores = detectCores()/2)
    
    if (group == "covid_recovered") {
      ab_segments <- unlist(lapply(lapply(inf_results, `[[`, 2), function(x) if (length(x) > 0) x[[1]] else NA))
      time_segments <- unlist(lapply(lapply(inf_results, `[[`, 3), function(x) if (length(x) > 0) x[[1]] else NA))
      size_segments <- unlist(lapply(lapply(inf_results, `[[`, 5), function(x) if (length(x) > 0) x[[1]] else NA))
      og_times <- unlist(lapply(lapply(inf_results, `[[`, 6), function(x) if (length(x) > 0) x[[1]] else NA))
      
      ids <- unique(get(group)$Record.ID)[!is.na(size_segments)]
      ab_segments <- na.omit(ab_segments)
      time_segments <- na.omit(time_segments)
      size_segments <- na.omit(size_segments)
      complete_no_segments <- rep(1, length(size_segments))
      og_times <- na.omit(og_times)
      
      stan_data <- list(N = length(ab_segments),
                        K = length(complete_no_segments),
                        J = length(size_segments),
                        ab = ab_segments,
                        times = time_segments,
                        no_segments = complete_no_segments,
                        size_segments = size_segments,
                        og_times = og_times,
                        ids = ids)
            
      stan_fit <- stan(file = here("stan_scripts/COVID_monophasic_model.stan"), data = stan_data, iter =  10000, warmup = 1000, chains = 4, control = control_params)
      
    } else {
      ab_segments <- unlist(lapply(inf_results, `[[`, 2))
      time_segments <- unlist(lapply(inf_results, `[[`, 3))
      no_segments <- unlist(lapply(inf_results, `[[`, 4))
      size_segments <- unlist(lapply(inf_results, `[[`, 5))
      og_times <- unlist(lapply(inf_results, `[[`, 6))
      
      complete_no_segments <- no_segments[no_segments != 0]
      
      
      stan_data <- list(N = length(ab_segments),
                        K = length(complete_no_segments),
                        J = length(size_segments),
                        ab = ab_segments,
                        times = time_segments,
                        no_segments = complete_no_segments,
                        size_segments = size_segments,
                        og_times = og_times,
                        og_segments = no_segments,
                        ids = unique(get(group)$Record.ID)[no_segments != 0])
      
      stan_fit <- stan(file = here("stan_scripts/COVID_monophasic_model.stan"), data = stan_data, iter =  10000, warmup = 1000, chains = 4, control = control_params)
    }
    assign(paste0("sp_IgG_", protein, "_", group), stan_fit)
    save(list=paste0("sp_IgG_", protein, "_", group), file = here(paste0("results/model_fits/sp_IgG_", protein, "_", group, ".Rdata")))
    assign(paste0("sp_IgG_", protein, "_", group, "_data"), stan_data)
    save(list=paste0("sp_IgG_", protein, "_", group, "_data"), file = here(paste0("results/model_fits/sp_IgG_", protein, "_", group, "_data.Rdata")))
  }
}

```




```{r}
traceplot(stan_fit, pars = c("lambda_mu", "lambda_sd", "rate"))

mcmc_pairs(stan_fit, pars = c("lambda_mu", "lambda_sd", "rate"), diag_fun = "dens", off_diag_fun = "hex")

```


Plot SP model fits.
```{r}
sp_model_fits <- function(stan_file, stan_data) {
  stan_results <- get(stan_file)
  pis <- predictive_interval(stan_results$y_rep, prob = 0.95)
  yrep_pis <- cbind(pis, medians = colMedians(stan_results$y_rep))
  
  sp_id_size <- c()
  pos <- 1
  for (i in 1:length(stan_data$no_segments)) {
    size <- 0
    for (j in 1:stan_data$no_segments[i]) {
      size <- size + stan_data$size_segments[pos]
      pos <- pos + 1
    }
    sp_id_size <- c(sp_id_size, size)
  }
  sp_ids <- rep(stan_data$ids, sp_id_size)
  
  single_plot_data <- as.data.frame(yrep_pis) %>% mutate(days = stan_data$og_times, ID = sp_ids)
  single_plot_data <- as.data.frame(lapply(single_plot_data, unlist))  %>% group_by(ID) %>% mutate(group = cumsum(lag(medians, default = first(medians)) < medians) + 1) 

  stan_input <- tibble(y = bp_stan_data$y, time = bp_stan_data$time, ID = rep(bp_stan_data$ids, bp_stan_data$size_y))
  
  ggplot() + 
    geom_ribbon(data = single_plot_data, 
                aes(x = days, 
                    ymin = X2.5., 
                    ymax = X97.5., 
                    colour = "95% posterior\npredictive interval",
                    group = group), 
                alpha = 0.5) + 
    geom_point(data = stan_input, 
               aes(x = time, y = y, colour = "Observed data")) + 
    geom_line(data = single_plot_data, aes(x = days, y = medians, colour = "Posterior predictive\nmedian", group = group)) + 
  facet_wrap(ID ~ ., scales = "free_x", ncol = 4) + 
    ylab("Adjusted MFI") + 
    xlab("Time since first exposure (days)") + 
    scale_colour_manual(values = c("darkgrey", "black", "black")) + 
    theme_bw() + 
    theme(axis.text=element_text(size=25), axis.title=element_text(size=25), strip.text = element_text(size = 25), legend.text=element_text(size=25), plot.title = element_text(size=27), legend.title=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
  ggsave(here(paste0("results/paper_plots_revised/", stan_file, "_model_fits.png")), height = 40, width = 20, dpi = 300)
  ggsave(here(paste0("results/paper_plots_revised/", stan_file, "_model_fits.pdf")), height = 40, width = 20, dpi = 300)
}

sp_model_fits("sp_rec_none_rbd", sp_IgG_RBD_covid_recovered_data)
  

```





















